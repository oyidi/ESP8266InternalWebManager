<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AntNet 0.0.1 alpha</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body>
	<div class="modal fade" id="msgBox" tabindex="-1" role="dialog" aria-labelledby="ModalLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="ModalLabel">提示</h4>
          </div>
          <div class="modal-body">
            <p id="msgBox_p"></p>
          </div>
		  <div class="modal-footer" id="msg-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">确定</button>
          </div>
        </div>
      </div>
    </div>
  	<nav class="navbar navbar-inverse">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">AntNet</a>
        </div>
      </div>
    </nav>
    
	<div class="container">
        <ul class="nav nav-tabs">
          <li role="presentation" class="active"><a href="#">主页</a></li>
        </ul>
    	<div class="starter-template">
            <h1 class="text-center">Ant Net管理系统</h1>
        </div>
        <div class="row">
        	<div class="col-xs-10 col-xs-offset-1">
            	<h3 class="text-center" id="dht"></h3>
            </div>
        </div>
        <div class="row">
			<div class="col-xs-10 col-xs-offset-1">
				<div class="col-xs-4">
					<a class="btn btn-default btn-block btn-lg" role="button" onclick="ledLight(1023,5,1)">1层亮灯</a>
				</div>
				<div class="col-xs-4">
					<a class="btn btn-default btn-block btn-lg" role="button" onclick="ledLight(512,5,1)">1层微亮</a>
				</div>
				<div class="col-xs-4">
					<a class="btn btn-default btn-block btn-lg" role="button" onclick="ledLight(0,5,1)">1层灭灯</a>
				</div>
			</div>
        	
        </div>
		<div class="row">
			<div class="col-xs-10 col-xs-offset-1">
				<div class="col-xs-4">
					<a class="btn btn-default btn-block btn-lg" role="button" onclick="ledLight(1023,5,2)">2层亮灯</a>
				</div>
				<div class="col-xs-4">
					<a class="btn btn-default btn-block btn-lg" role="button" onclick="ledLight(512,5,2)">2层微亮</a>
				</div>
				<div class="col-xs-4">
					<a class="btn btn-default btn-block btn-lg" role="button" onclick="ledLight(0,5,2)">2层灭灯</a>
				</div>
			</div>
        </div>
		<hr>
		<div class="row">
			<div class="col-xs-6 col-xs-offset-3">
				<form>
				  <div class="form-group">
					<p class="lead" >修改UKEY</p>
					<input id="ukey_input" class="form-control" type="text">
				  </div>
				</form>
				<button class="btn btn-default" onclick="changeUKey()">确认修改</button>
			</div>
		</div>
        <hr>
		<div class="row">
			<div class="col-xs-6 col-xs-offset-3">
				<form>
					<div class="form-group">
						<p class="lead">修改接入Wifi参数</p>
						<label>SSID名称</label>
						<input id="wlan_ssid" class="ssid form-control" type="text" name="ssid"/>
						<label>密码</label>
						<input id="wlan_password" class="passwd form-control" type="password" name="passwd"/>
					</div>
				</form>
                <button class="btn btn-default" onClick="setup_wlan()">修改Wifi接入点</button>
			</div>
		</div>
    </div>
    <script src="//cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
	<script type="text/javascript">
	getSensor();
	get_ukey();
	get_wlan();
	//setTimeout("timeLoop()",5000);
	function timeLoop () {
		//alert("timeLoop");
		getSensor();
		setTimeout("timeLoop()",10000);
	}
	function ledLight(lv, time, pin) {
		var xh = new XMLHttpRequest();
		xh.onreadystatechange = function(){};
		xh.open("GET", "/sensor?sensor=led&action=light&lv=" + lv + "&time=" + time + "&pin=" + pin, true);
		xh.send(null);
	}
	function getSensor() {
		var xh = new XMLHttpRequest();
		xh.onreadystatechange = function(){
			if (xh.readyState == 4){
			  if(xh.status == 200) {
				var json = JSON.parse(xh.responseText);
				for(var i = 0;i < json.sensor_data.length;i++) {
				  if(json.sensor_data[i].sensor == "DHT11") {
						document.getElementById("dht").innerHTML = "温度:" + json.sensor_data[i].temp + " 湿度:" +  json.sensor_data[i].hum
				  }
				}
			  }
			}
		};
		xh.open("GET", "/sensor?sensor=all&action=get", true);
		xh.send(null);
	}
	function get_ukey() {
		var xh = new XMLHttpRequest();
		xh.onreadystatechange = function(){
			if (xh.readyState == 4){
				if(xh.status == 200) {
					var result = xh.responseText;
					document.getElementById("ukey_input").value = result;
				}
			}
		};
		xh.open("GET", "./setup?p=get_ukey", true);
		xh.send(null);
	}
	function get_wlan() {
		var xh = new XMLHttpRequest();
		xh.onreadystatechange = function(){
			if (xh.readyState == 4){
				if(xh.status == 200) {
					var result = xh.responseText;
					var json = JSON.parse(result);
					document.getElementById("wlan_ssid").value = json.SSID;
					document.getElementById("wlan_password").value = json.Passwd;
				}
			}
		};
		xh.open("GET", "./setup?p=get_wlan", true);
		xh.send(null);
	}
	function setup_wlan() {
		var ssid = document.getElementsByClassName("ssid").item(0).value;
		var passwd = document.getElementsByClassName("passwd").item(0).value;
		var xh = new XMLHttpRequest();
		xh.onreadystatechange = function(){
			if (xh.readyState == 4){
				if(xh.status == 200) {
					var result = xh.responseText;
					if(result == ssid)
						showModel('设置成功');
				}
			}
		};
		xh.open("POST", "/wifi_access", true);
		xh.send("ssid="+ssid + "&passwd=" + passwd);
	}
	function changeUKey() {
		var xh = new XMLHttpRequest();
		var ukey = document.getElementById("ukey_input").value;
		xh.onreadystatechange = function(){
			if (xh.readyState == 4){
				if(xh.status == 200) {
					var result = xh.responseText;
					if(result == ukey) {
						showModel('UKEY设置成功');
					}
				}
			}
		};
		xh.open("GET", "./setup?p=ukey&ukey="+ukey, true);
		xh.send(null);
	}
	function showModel(conext) {
		$('#msgBox_p').html(conext);
		$('#msg-footer').hide();
		$('#msgBox').modal('show');
	}
	</script>
  </body>
</html>